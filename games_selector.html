<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор игр</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            padding-bottom: 80px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .search-container {
            position: sticky;
            top: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 10px 0;
            margin-bottom: 10px;
            z-index: 100;
        }
        
        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            color: var(--tg-theme-text-color, #000);
            outline: none;
            transition: border-color 0.2s;
        }
        
        .search-box:focus {
            border-color: var(--tg-theme-button-color, #007AFF);
        }
        
        .games-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .game-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .game-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .game-item.selected {
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, white);
        }
        
        .game-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            accent-color: var(--tg-theme-button-color, #007AFF);
        }
        
        .game-name {
            flex: 1;
            font-size: 16px;
            font-weight: 500;
        }
        
        .selected-counter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, white);
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #999);
            font-size: 16px;
        }
        
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px;
            font-size: 10px;
            border-radius: 3px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="debug-info" id="debugInfo">Загрузка...</div>
    
    <div class="header">Выбери свои игры</div>
    
    <div class="search-container">
        <input type="text" class="search-box" placeholder="Поиск игр..." id="searchInput">
    </div>
    
    <div class="games-list" id="gamesList"></div>
    
    <div class="selected-counter" id="selectedCounter" style="display: none;">
        Выбрано: <span id="selectedCount">0</span>
    </div>

    <script>
        const allGames = [
            "Counter-Strike 2",
            "Valorant", 
            "Dota 2",
            "League of Legends",
            "Apex Legends",
            "PUBG",
            "Fortnite",
            "Overwatch 2",
            "Call of Duty",
            "Rainbow Six Siege",
            "Rocket League",
            "Destiny 2",
            "Battlefield",
            "Heroes of the Storm",
            "Smite",
            "Mobile Legends",
            "Wild Rift",
            "PUBG Mobile",
            "Clash Royale",
            "Clash of Clans",
            "Brawl Stars",
            "Free Fire",
            "Call of Duty Mobile",
            "Arena of Valor",
            "Genshin Impact",
            "Honkai Star Rail",
            "Minecraft",
            "Among Us",
            "Fall Guys",
            "FIFA 24",
            "NBA 2K24",
            "Mortal Kombat",
            "Tekken 8",
            "Street Fighter 6",
            "World of Warcraft",
            "Diablo 4",
            "Forza Horizon",
            "Gran Turismo",
            "Need for Speed",
            "F1 2023",
            "Cyberpunk 2077",
            "GTA V",
            "Red Dead Redemption 2",
            "The Witcher 3",
            "Elden Ring"
        ].sort();
        
        let selectedGames = [];
        
        // Отладочная функция
        function updateDebugInfo(message) {
            const debugEl = document.getElementById('debugInfo');
            debugEl.textContent = message;
            console.log('DEBUG:', message);
        }
        
        function renderGames(gamesToRender = allGames) {
            const gamesList = document.getElementById('gamesList');
            gamesList.innerHTML = '';
            
            if (gamesToRender.length === 0) {
                gamesList.innerHTML = '<div class="no-results">Игры не найдены</div>';
                return;
            }
            
            gamesToRender.forEach(gameName => {
                const gameItem = document.createElement('div');
                const isSelected = selectedGames.includes(gameName);
                gameItem.className = `game-item ${isSelected ? 'selected' : ''}`;
                
                gameItem.innerHTML = `
                    <input type="checkbox" class="game-checkbox" ${isSelected ? 'checked' : ''}>
                    <span class="game-name">${gameName}</span>
                `;
                
                gameItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    toggleGame(gameName);
                });
                
                gamesList.appendChild(gameItem);
            });
            
            updateSelectedCounter();
        }
        
        function toggleGame(gameName) {
            const index = selectedGames.indexOf(gameName);
            if (index >= 0) {
                selectedGames.splice(index, 1);
                updateDebugInfo(`Убрана игра: ${gameName}`);
            } else {
                selectedGames.push(gameName);
                updateDebugInfo(`Добавлена игра: ${gameName}`);
            }
            renderGames(getCurrentFilteredGames());
        }
        
        function getCurrentFilteredGames() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            return allGames.filter(game => game.toLowerCase().includes(searchTerm));
        }
        
        function updateSelectedCounter() {
            const counter = document.getElementById('selectedCounter');
            const count = document.getElementById('selectedCount');
            
            count.textContent = selectedGames.length;
            
            if (selectedGames.length > 0) {
                counter.style.display = 'block';
                if (typeof Telegram !== 'undefined' && Telegram.WebApp && Telegram.WebApp.MainButton) {
                    Telegram.WebApp.MainButton.text = `Готово (${selectedGames.length})`;
                }
            } else {
                counter.style.display = 'none';
                if (typeof Telegram !== 'undefined' && Telegram.WebApp && Telegram.WebApp.MainButton) {
                    Telegram.WebApp.MainButton.text = "Выберите игры";
                }
            }
        }
        
        // Поиск
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const filtered = getCurrentFilteredGames();
            renderGames(filtered);
            updateDebugInfo(`Поиск: ${e.target.value}, найдено: ${filtered.length}`);
        });
        
        // Проверяем доступность Telegram WebApp
        if (typeof Telegram === 'undefined') {
            updateDebugInfo('Telegram WebApp недоступен');
        } else {
            updateDebugInfo('Telegram WebApp найден');
            
            // Инициализация Telegram Web App
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            
            updateDebugInfo('WebApp инициализирован');
            
            // Настройка главной кнопки
            if (Telegram.WebApp.MainButton) {
                Telegram.WebApp.MainButton.text = "Выберите игры";
                Telegram.WebApp.MainButton.show();
                updateDebugInfo('Кнопка настроена');
                
                Telegram.WebApp.MainButton.onClick(() => {
                    updateDebugInfo('Кнопка нажата');
                    
                    if (selectedGames.length > 0) {
                        const dataToSend = {
                            type: "games_selected",
                            games: selectedGames
                        };
                        
                        updateDebugInfo(`Отправка: ${selectedGames.length} игр`);
                        console.log('Отправляемые данные:', dataToSend);
                        
                        try {
                            Telegram.WebApp.sendData(JSON.stringify(dataToSend));
                            updateDebugInfo('Данные отправлены');
                            
                            // Закрываем через небольшую задержку
                            setTimeout(() => {
                                Telegram.WebApp.close();
                            }, 100);
                            
                        } catch (error) {
                            updateDebugInfo(`Ошибка отправки: ${error.message}`);
                            console.error('Ошибка:', error);
                        }
                    } else {
                        Telegram.WebApp.showAlert("Выберите хотя бы одну игру!");
                        updateDebugInfo('Показано предупреждение');
                    }
                });
            } else {
                updateDebugInfo('MainButton недоступна');
            }
        }
        
        // Первый рендер
        renderGames();
        updateDebugInfo(`Загружено ${allGames.length} игр`);
    </script>
</body>
</html>
